name: Full Sync Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'
  VITE_SPEC_VERSION: 'v1'

jobs:
  validate:
    name: Contract & Type Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint OpenAPI Spec
        run: npm run lint:spec
        continue-on-error: false

      - name: Generate SDK from OpenAPI spec
        run: npm run gen:sdk
        continue-on-error: true  # SDK gen optional for now

      - name: TypeScript type check
        run: npm run typecheck

      - name: Build application
        run: npm run build

  smoke-test:
    name: API Smoke Test
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run API smoke tests
        run: npm run smoke:api
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_STAGING }}
          VITE_SPEC_VERSION: ${{ env.VITE_SPEC_VERSION }}
        continue-on-error: false

  sync-gate-check:
    name: Sync Gate Verification
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify spec files exist
        run: |
          echo "Checking contract files..."
          test -f specs/v1/openapi.yaml || (echo "❌ OpenAPI spec missing" && exit 1)
          test -f .spectral.yaml || (echo "❌ Spectral config missing" && exit 1)
          echo "✅ Contract files present"

      - name: Verify sync gate implementation
        run: |
          echo "Checking sync gate files..."
          test -f client/src/lib/syncGate.ts || (echo "❌ syncGate.ts missing" && exit 1)
          test -f client/src/lib/http.ts || (echo "❌ http.ts missing" && exit 1)
          echo "✅ Sync gate files present"

      - name: Verify backend endpoints
        run: |
          echo "Checking backend health/version routes..."
          grep -q 'app.get("/health"' server/routes.ts || (echo "❌ /health route missing" && exit 1)
          grep -q 'app.get("/version"' server/routes.ts || (echo "❌ /version route missing" && exit 1)
          grep -q 'x-request-id' server/index.ts || (echo "❌ requestId middleware missing" && exit 1)
          echo "✅ Backend sync gate endpoints present"

      - name: Summary
        run: |
          echo ""
          echo "================================"
          echo "  SYNC GATE VALIDATION PASSED"
          echo "================================"
          echo ""
          echo "Contract: specs/v1/openapi.yaml"
          echo "Spec Version: ${{ env.VITE_SPEC_VERSION }}"
          echo ""

